name: Generate Sitemap
on:
  push:
    branches:
      - main
  workflow_dispatch:      # Keep manual trigger for testing

permissions:
  contents: write

jobs:
  generate-sitemap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Sitemap Generator
        run: npm install -g sitemap-generator-cli

      - name: Generate Sitemap
        run: |
          sitemap-generator https://doorstepsupport.com \
            --filepath sitemap.xml \
            --max-depth 10 \
            --max-enqueue 1000 \
            --change-freq weekly \
            --priority 0.8 \
            --ignore-robots-txt
          
          # Validation check
          if [ ! -f sitemap.xml ]; then
            echo "Sitemap generation failed"
            exit 1
          fi
          
          # Add .html extensions to URLs
          sed -i 's|<loc>\(https://doorstepsupport.com/[^<]*[^/.]\)</loc>|<loc>\1.html</loc>|g' sitemap.xml
          
          # Fix any double .html extensions
          sed -i 's|\.html\.html|.html|g' sitemap.xml
          
          echo "Generated sitemap content:"
          cat sitemap.xml

      - name: Generate Robots.txt
        run: |
          cat > robots.txt << 'EOF'
          User-agent: *
          Allow: /

          # Disallow admin/template folders
          Disallow: /assets/vendors/

          # Sitemap location
          Sitemap: https://doorstepsupport.com/sitemap.xml
          EOF

      - name: Validate Generated Files
        run: |
          # Check sitemap exists and has content
          if [ ! -s sitemap.xml ]; then
            echo "Error: sitemap.xml is empty or missing"
            exit 1
          fi

          # Check robots.txt exists and has content
          if [ ! -s robots.txt ]; then
            echo "Error: robots.txt is empty or missing"
            exit 1
          fi

          # Count URLs in sitemap
          url_count=$(grep -c "<loc>" sitemap.xml || echo "0")
          echo "Found $url_count URLs in sitemap"

          # Verify all HTML pages have .html extension
          html_pages=$(grep "<loc>" sitemap.xml | grep -v "\.\(jpg\|png\|gif\|css\|js\)") 
          if echo "$html_pages" | grep -q "[^.]</loc>"; then
            echo "Error: Found URLs without .html extension"
            echo "$html_pages"
            exit 1
          fi

      - name: Commit files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add sitemap.xml robots.txt
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-update: sitemap.xml and robots.txt [skip ci]"
            git push
          fi

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Sitemap Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Total URLs: $(grep -c "<loc>" sitemap.xml || echo '0')" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Pages: $(grep "<loc>" sitemap.xml | grep -c "\.html" || echo '0')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "- sitemap.xml (with .html extensions)" >> $GITHUB_STEP_SUMMARY
          echo "- robots.txt (with vendor exclusions)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify sitemap at https://doorstepsupport.com/sitemap.xml" >> $GITHUB_STEP_SUMMARY
          echo "2. Submit sitemap in Google Search Console" >> $GITHUB_STEP_SUMMARY