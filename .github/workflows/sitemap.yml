name: Generate Sitemap and Robots

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * 0"   # run weekly (Sunday midnight UTC)
  workflow_dispatch:  # allow manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Sitemap Generator
        run: npm install -g sitemap-generator-cli

      - name: Generate Sitemap
        run: |
          sitemap-generator https://doorstepsupport.com \
            --filepath sitemap.xml \
            --max-depth 10 \
            --max-enqueue 1000 \
            --change-freq weekly \
            --priority-map "1.0,0.8,0.6,0.4" \
            --last-mod \
            --query-string \
            --ignore-robots-txt

      - name: Fix Sitemap URLs (ensure .html extensions are preserved)
        run: |
          # Ensure sitemap.xml exists
          if [ ! -f sitemap.xml ]; then
            echo "Sitemap generation failed"
            exit 1
          fi
          
          # Display original sitemap for debugging
          echo "Original sitemap:"
          cat sitemap.xml
          
          # Add .html extension to URLs that don't have file extensions
          # This preserves URLs that already have .html, .jpg, .png, etc.
          sed -i 's|<loc>\(https://doorstepsupport.com/[^<]*[^/.]\)</loc>|<loc>\1.html</loc>|g' sitemap.xml
          
          # Fix double .html.html if any were created
          sed -i 's|\.html\.html|.html|g' sitemap.xml
          
          # Display fixed sitemap
          echo ""
          echo "Fixed sitemap:"
          cat sitemap.xml

      - name: Generate Robots.txt
        run: |
          cat > robots.txt << 'EOF'
          User-agent: *
          Allow: /
          
          # Disallow admin/template folders
          Disallow: /assets/vendors/
          
          # Sitemap location
          Sitemap: https://doorstepsupport.com/sitemap.xml
          EOF

      - name: Generate Additional SEO Files
        run: |
          # Create a humans.txt file
          cat > humans.txt << 'EOF'
          /* TEAM */
          Website: DoorstepSupport
          Location: Karachi, Pakistan
          
          /* SITE */
          Last update: $(date +%Y/%m/%d)
          Standards: HTML5, CSS3
          Components: Bootstrap, jQuery
          Software: GitHub Pages
          EOF

      - name: Commit files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add sitemap.xml robots.txt humans.txt
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update: sitemap.xml, robots.txt, humans.txt [skip ci]"
          git push || echo "No changes to push"

      - name: Validate Sitemap
        run: |
          echo "Validating sitemap structure..."
          if grep -q "https://doorstepsupport.com" sitemap.xml; then
            echo "âœ… Sitemap contains correct domain"
          else
            echo "âŒ Sitemap domain validation failed"
            exit 1
          fi
          
          # Count URLs
          url_count=$(grep -c "<loc>" sitemap.xml || echo "0")
          echo "ðŸ“Š Total URLs in sitemap: $url_count"
          
          # Check for .html extensions
          html_count=$(grep -c "\.html</loc>" sitemap.xml || echo "0")
          echo "ðŸ“„ URLs with .html extension: $html_count"
          
          if [ "$url_count" -lt 5 ]; then
            echo "âš ï¸  Warning: Very few URLs found. Check crawling."
          fi

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Sitemap Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Sitemap generated: sitemap.xml" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Robots.txt created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Humans.txt created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… URLs normalized with .html extensions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify sitemap at: https://doorstepsupport.com/sitemap.xml" >> $GITHUB_STEP_SUMMARY
          echo "2. Submit to Google Search Console" >> $GITHUB_STEP_SUMMARY
          echo "3. Test with: https://www.xml-sitemaps.com/validate-xml-sitemap.html" >> $GITHUB_STEP_SUMMARY
