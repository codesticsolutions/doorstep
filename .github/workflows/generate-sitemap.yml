name: Generate Sitemap

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate sitemap.xml (No Python)
        env:
          BASE_URL: https://doorstepsupport.com
        run: |
          echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml

          find . -type f -name "*.html" \
            ! -path "./assets/*" \
            ! -path "./.git/*" \
            ! -path "./.github/*" \
            ! -name "404.html" \
            ! -name "robots.txt.html" \
            ! -name "robots.txt" \
            ! -name "humans.txt" \
            ! -name "blog.html" \
            ! -name "services.html" \
            ! -name "@@link.html" \
          | while read file; do

              path="${file#./}"
              url="${path%.html}"

              if [ "$url" = "index" ]; then
                loc="$BASE_URL/"
              else
                loc="$BASE_URL/$url"
              fi

              # ðŸ”¥ SERVICE-FIRST SEO PRIORITIES
              if [ "$loc" = "$BASE_URL/" ]; then
                priority="1.0"
                freq="daily"

              elif [ "$loc" = "$BASE_URL/services" ]; then
                priority="0.95"
                freq="weekly"

              elif [[ "$loc" == *"/services/"* ]]; then
                priority="0.9"
                freq="weekly"

              elif [[ "$loc" == *"/blog/"* ]]; then
                priority="0.6"
                freq="weekly"

              elif [[ "$loc" == *"/about"* || "$loc" == *"/contact"* ]]; then
                priority="0.5"
                freq="monthly"

              else
                priority="0.4"
                freq="monthly"
              fi

              lastmod=$(date -u +"%Y-%m-%dT%H:%M:%S+00:00")

              echo "<url><loc>$loc</loc><lastmod>$lastmod</lastmod><changefreq>$freq</changefreq><priority>$priority</priority></url>" >> sitemap.xml
          done

          echo '</urlset>' >> sitemap.xml

      - name: Commit sitemap.xml
        uses: EndBug/add-and-commit@v9
        with:
          add: sitemap.xml
          message: "Automated: Generate sitemap.xml"
          author_name: GitHub Actions
          author_email: actions@github.com